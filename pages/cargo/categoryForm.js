"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var index_1 = require("../../request/index");
var manager_1 = require("../../upload/manager");
var deepClone_1 = require("../../utils/deepClone");
Page({
    data: {
        category: null,
        cargoId: '',
        parent: null,
        formData: {
            name: '',
            price: '',
            count: null,
            note: '',
        },
        photo: null,
        files: [],
        tag_selection: '_input',
        tag_selections: [],
        tag: null,
        tags: [],
    },
    onLoad: function (options) {
        var _this = this;
        if (options.id) {
            index_1.get("/cargo_categories/" + options.id).then(function (res) {
                var category = res.data;
                var name = category.name, price = category.price, count = category.count, note = category.note, photo = category.photo;
                var formData = { name: name, price: price, count: count, note: note };
                var files = [];
                if (category.photo) {
                    files = [{ url: manager_1.default.getUrl(photo), loading: false }];
                }
                _this.setData({ category: category, formData: formData, photo: photo, files: files });
                _this.loadTags(category.parent_id);
            });
            return;
        }
        this.loadTags(options.parentId);
        this.setData({ cargoId: options.cargoId });
    },
    loadTags: function (parentId) {
        var _this = this;
        if (parentId) {
            index_1.get("/cargo_categories/" + parentId).then(function (res) {
                _this.setData({ parent: res.data });
                _this.doLoadTags();
            });
        }
        else {
            this.doLoadTags();
        }
    },
    doLoadTags: function () {
        var _this = this;
        index_1.get('/tags?tag_type=cargo_category').then(function (res) {
            var tag_selections = [];
            res.data.forEach(function (e) {
                if (!_this.data.parent || _this.data.parent.tag_id !== e.id) {
                    tag_selections.push({ name: e.name, value: e.name });
                }
            });
            tag_selections.push({ name: '手动输入分类名称', value: '_input' });
            _this.setData({ tag_selections: tag_selections });
            res.data.forEach(function (e) {
                e.value = JSON.parse(e.value).map(function (v) {
                    return { name: v, value: v };
                });
            });
            _this.setData({ tags: res.data });
            if (_this.data.category && _this.data.category.tag_id) {
                var tag = res.data.find(function (e) { return e.id === _this.data.category.tag_id; });
                if (tag) {
                    _this.setData({ tag_selection: tag.name, tag: _this.data.category.name });
                }
            }
        });
    },
    onTagSelectionChange: function (e) {
        this.setData({ tag_selection: e.detail.value });
    },
    onTagChange: function (e) {
        this.setData({ tag: e.detail.value });
    },
    formInputChange: function (e) {
        var _a;
        var field = e.currentTarget.dataset.field;
        this.setData((_a = {},
            _a["formData." + field] = e.detail.value,
            _a));
    },
    showError: function (error) {
        this.setData({
            error: error
        });
    },
    onUploadError: function () {
        wx.showToast({
            title: '图片上传失败',
            icon: 'none'
        });
    },
    uploadFile: function () {
        console.log(this.data.files);
        wx.showToast({
            title: 'uploadFile',
            icon: 'none'
        });
    },
    onSelectFile: function (e) {
        var _this = this;
        manager_1.default.upload(e.detail.tempFilePaths[0]).then(function (res) {
            var files = [{ url: manager_1.default.getUrl(res.data.key), loading: false }];
            _this.setData({ files: files, photo: res.data.key });
        });
    },
    submit: function () {
        var _this = this;
        var formData = this.data.formData;
        if (this.data.tag_selection === '_input') {
            if (!formData.name) {
                this.showError('请输入名称');
                return;
            }
        }
        else {
            if (!this.data.tag) {
                this.showError("\u8BF7\u9009\u62E9" + this.data.tag_selection);
                return;
            }
        }
        if (!formData.price) {
            this.showError('请输入价格');
            return;
        }
        var data = deepClone_1.default(formData);
        data.photo = this.data.photo;
        if (this.data.tag_selection !== '_input') {
            data.tag_id = this.data.tags.find(function (e) { return e.name === _this.data.tag_selection; }).id;
            data.name = this.data.tag;
        }
        if (this.data.parent) {
            data.parent_id = this.data.parent.id;
        }
        wx.showLoading({ title: '提交中' });
        var promise;
        if (this.data.category) {
            promise = index_1.patch("/cargo_categories/" + this.data.category.id, data);
        }
        else {
            promise = index_1.post("/cargo_categories?cargo_id=" + this.data.cargoId, data);
        }
        promise.then(function () {
            wx.hideLoading();
            wx.navigateBack();
        }).catch(function () {
            wx.hideLoading();
            wx.showToast({
                title: '请求失败，请重新尝试',
                icon: 'none'
            });
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2F0ZWdvcnlGb3JtLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2F0ZWdvcnlGb3JtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQXNEO0FBQ3RELGdEQUFnRDtBQUNoRCxtREFBNkM7QUFFN0MsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osUUFBUSxFQUFFLElBQUk7UUFDZCxPQUFPLEVBQUUsRUFBRTtRQUNYLE1BQU0sRUFBRSxJQUFJO1FBQ1osUUFBUSxFQUFFO1lBQ1IsSUFBSSxFQUFFLEVBQUU7WUFDUixLQUFLLEVBQUUsRUFBRTtZQUNULEtBQUssRUFBRSxJQUFJO1lBQ1gsSUFBSSxFQUFFLEVBQUU7U0FDVDtRQUNELEtBQUssRUFBRSxJQUFJO1FBQ1gsS0FBSyxFQUFFLEVBQUU7UUFDVCxhQUFhLEVBQUUsUUFBUTtRQUN2QixjQUFjLEVBQUUsRUFBRTtRQUNsQixHQUFHLEVBQUUsSUFBSTtRQUNULElBQUksRUFBRSxFQUFFO0tBQ1Q7SUFFRCxNQUFNLFlBQUMsT0FBTztRQUFkLGlCQXVCQztRQXRCQyxJQUFJLE9BQU8sQ0FBQyxFQUFFLEVBQUU7WUFDZCxXQUFHLENBQUMsdUJBQXFCLE9BQU8sQ0FBQyxFQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQSxHQUFHO2dCQUM3QyxJQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFBO2dCQUNqQixJQUFBLElBQUksR0FBZ0MsUUFBUSxLQUF4QyxFQUFFLEtBQUssR0FBeUIsUUFBUSxNQUFqQyxFQUFFLEtBQUssR0FBa0IsUUFBUSxNQUExQixFQUFFLElBQUksR0FBWSxRQUFRLEtBQXBCLEVBQUUsS0FBSyxHQUFLLFFBQVEsTUFBYixDQUFhO2dCQUNwRCxJQUFNLFFBQVEsR0FBRyxFQUFFLElBQUksTUFBQSxFQUFFLEtBQUssT0FBQSxFQUFFLEtBQUssT0FBQSxFQUFFLElBQUksTUFBQSxFQUFFLENBQUE7Z0JBRzdDLElBQUksS0FBSyxHQUFHLEVBQUUs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QUFZLEVBQUUsQ0FBQTtRQUNuQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDUCxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7WUFDaEIsRUFBRSxDQUFDLFNBQVMsQ0FBQztnQkFDWCxLQUFLLEVBQUUsWUFBWTtnQkFDbkIsSUFBSSxFQUFFLE1BQU07YUFDYixDQUFDLENBQUE7UUFDSixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXQsIHBvc3QsIHBhdGNoIH0gZnJvbSAnLi4vLi4vcmVxdWVzdC9pbmRleCdcbmltcG9ydCBVcGxvYWRNYW5hZ2VyIGZyb20gJy4uLy4uL3VwbG9hZC9tYW5hZ2VyJ1xuaW1wb3J0IGRlZXBDbG9uZSBmcm9tICcuLi8uLi91dGlscy9kZWVwQ2xvbmUnXG5cblBhZ2Uoe1xuICBkYXRhOiB7XG4gICAgY2F0ZWdvcnk6IG51bGwsXG4gICAgY2FyZ29JZDogJycsXG4gICAgcGFyZW50OiBudWxsLFxuICAgIGZvcm1EYXRhOiB7XG4gICAgICBuYW1lOiAnJyxcbiAgICAgIHByaWNlOiAnJyxcbiAgICAgIGNvdW50OiBudWxsLFxuICAgICAgbm90ZTogJycsXG4gICAgfSxcbiAgICBwaG90bzogbnVsbCxcbiAgICBmaWxlczogW10sXG4gICAgdGFnX3NlbGVjdGlvbjogJ19pbnB1dCcsXG4gICAgdGFnX3NlbGVjdGlvbnM6IFtdLFxuICAgIHRhZzogbnVsbCxcbiAgICB0YWdzOiBbXSxcbiAgfSxcblxuICBvbkxvYWQob3B0aW9ucykge1xuICAgIGlmIChvcHRpb25zLmlkKSB7XG4gICAgICBnZXQoYC9jYXJnb19jYXRlZ29yaWVzLyR7b3B0aW9ucy5pZH1gKS50aGVuKHJlcyA9PiB7XG4gICAgICAgIGNvbnN0IGNhdGVnb3J5ID0gcmVzLmRhdGFcbiAgICAgICAgY29uc3QgeyBuYW1lLCBwcmljZSwgY291bnQsIG5vdGUsIHBob3RvIH0gPSBjYXRlZ29yeVxuICAgICAgICBjb25zdCBmb3JtRGF0YSA9IHsgbmFtZSwgcHJpY2UsIGNvdW50LCBub3RlIH1cblxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGxldCBmaWxlcyA9IFtdXG4gICAgICAgIGlmIChjYXRlZ29yeS5waG90bykge1xuICAgICAgICAgIGZpbGVzID0gW3sgdXJsOiBVcGxvYWRNYW5hZ2VyLmdldFVybChwaG90byksIGxvYWRpbmc6IGZhbHNlIH1dXG4gICAgICAgIH1cblxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7IGNhdGVnb3J5LCBmb3JtRGF0YSwgcGhvdG8sIGZpbGVzIH0pXG4gICAgICAgIHRoaXMubG9hZFRhZ3MoY2F0ZWdvcnkucGFyZW50X2lkKVxuICAgICAgfSlcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIHRoaXMubG9hZFRhZ3Mob3B0aW9ucy5wYXJlbnRJZClcblxuICAgIHRoaXMuc2V0RGF0YSh7IGNhcmdvSWQ6IG9wdGlvbnMuY2FyZ29JZCB9KVxuICB9LFxuXG4gIGxvYWRUYWdzKHBhcmVudElkOiBhbnkpIHtcbiAgICBpZiAocGFyZW50SWQpIHtcbiAgICAgIGdldChgL2NhcmdvX2NhdGVnb3JpZXMvJHtwYXJlbnRJZH1gKS50aGVuKHJlcyA9PiB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7IHBhcmVudDogcmVzLmRhdGEgfSlcbiAgICAgICAgdGhpcy5kb0xvYWRUYWdzKClcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZG9Mb2FkVGFncygpXG4gICAgfVxuICB9LFxuXG4gIGRvTG9hZFRhZ3MoKSB7XG4gICAgZ2V0KCcvdGFncz90YWdfdHlwZT1jYXJnb19jYXRlZ29yeScpLnRoZW4ocmVzID0+IHtcbiAgICAgIGxldCB0YWdfc2VsZWN0aW9ucyA9IFtdXG4gICAgICByZXMuZGF0YS5mb3JFYWNoKChlOiBhbnkpID0+IHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBpZiAoIXRoaXMuZGF0YS5wYXJlbnQgfHwgdGhpcy5kYXRhLnBhcmVudC50YWdfaWQgIT09IGUuaWQpIHtcbiAgICAgICAgICB0YWdfc2VsZWN0aW9ucy5wdXNoKHsgbmFtZTogZS5uYW1lLCB2YWx1ZTogZS5uYW1lIH0pXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICB0YWdfc2VsZWN0aW9ucy5wdXNoKHsgbmFtZTogJ+aJi+WKqOi+k+WFpeWIhuexu+WQjeensCcsIHZhbHVlOiAnX2lucHV0JyB9KVxuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgdGhpcy5zZXREYXRhKHsgdGFnX3NlbGVjdGlvbnMgfSlcblxuICAgICAgcmVzLmRhdGEuZm9yRWFjaCgoZTogYW55KSA9PiB7XG4gICAgICAgIGUudmFsdWUgPSBKU09OLnBhcnNlKGUudmFsdWUpLm1hcCgodjogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHsgbmFtZTogdiwgdmFsdWU6IHYgfVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICAgIHRoaXMuc2V0RGF0YSh7IHRhZ3M6IHJlcy5kYXRhIH0pXG5cbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIGlmICh0aGlzLmRhdGEuY2F0ZWdvcnkgJiYgdGhpcy5kYXRhLmNhdGVnb3J5LnRhZ19pZCkge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGxldCB0YWcgPSByZXMuZGF0YS5maW5kKChlOiBhbnkpID0+IGUuaWQgPT09IHRoaXMuZGF0YS5jYXRlZ29yeS50YWdfaWQpXG4gICAgICAgIGlmICh0YWcpIHtcbiAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgdGhpcy5zZXREYXRhKHsgdGFnX3NlbGVjdGlvbjogdGFnLm5hbWUsIHRhZzogdGhpcy5kYXRhLmNhdGVnb3J5Lm5hbWUgfSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG5cbiAgb25UYWdTZWxlY3Rpb25DaGFuZ2UoZTogYW55KSB7XG4gICAgdGhpcy5zZXREYXRhKHsgdGFnX3NlbGVjdGlvbjogZS5kZXRhaWwudmFsdWUgfSk7XG4gIH0sXG5cbiAgb25UYWdDaGFuZ2UoZTogYW55KSB7XG4gICAgdGhpcy5zZXREYXRhKHsgdGFnOiBlLmRldGFpbC52YWx1ZSB9KTtcbiAgfSxcblxuICBmb3JtSW5wdXRDaGFuZ2UoZTogYW55KSB7XG4gICAgY29uc3QgeyBmaWVsZCB9ID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXRcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgW2Bmb3JtRGF0YS4ke2ZpZWxkfWBdOiBlLmRldGFpbC52YWx1ZVxuICAgIH0pXG4gIH0sXG5cbiAgc2hvd0Vycm9yKGVycm9yOiBzdHJpbmcpIHtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgZXJyb3JcbiAgICB9KVxuICB9LFxuXG4gIG9uVXBsb2FkRXJyb3IoKSB7XG4gICAgd3guc2hvd1RvYXN0KHtcbiAgICAgIHRpdGxlOiAn5Zu+54mH5LiK5Lyg5aSx6LSlJyxcbiAgICAgIGljb246ICdub25lJ1xuICAgIH0pXG4gIH0sXG5cbiAgdXBsb2FkRmlsZSgpIHtcbiAgICBjb25zb2xlLmxvZyh0aGlzLmRhdGEuZmlsZXMpXG4gICAgd3guc2hvd1RvYXN0KHtcbiAgICAgIHRpdGxlOiAndXBsb2FkRmlsZScsXG4gICAgICBpY29uOiAnbm9uZSdcbiAgICB9KVxuICB9LFxuXG4gIG9uU2VsZWN0RmlsZShlOiBhbnkpIHtcbiAgICBVcGxvYWRNYW5hZ2VyLnVwbG9hZChlLmRldGFpbC50ZW1wRmlsZVBhdGhzWzBdKS50aGVuKHJlcyA9PiB7XG4gICAgICBsZXQgZmlsZXMgPSBbeyB1cmw6IFVwbG9hZE1hbmFnZXIuZ2V0VXJsKHJlcy5kYXRhLmtleSksIGxvYWRpbmc6IGZhbHNlIH1dXG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICB0aGlzLnNldERhdGEoeyBmaWxlcywgcGhvdG86IHJlcy5kYXRhLmtleSB9KVxuICAgIH0pXG4gIH0sXG5cbiAgc3VibWl0KCkge1xuICAgIGxldCBmb3JtRGF0YSA9IHRoaXMuZGF0YS5mb3JtRGF0YVxuICAgIGlmICh0aGlzLmRhdGEudGFnX3NlbGVjdGlvbiA9PT0gJ19pbnB1dCcpIHtcbiAgICAgIGlmICghZm9ybURhdGEubmFtZSkge1xuICAgICAgICB0aGlzLnNob3dFcnJvcign6K+36L6T5YWl5ZCN56ewJylcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghdGhpcy5kYXRhLnRhZykge1xuICAgICAgICB0aGlzLnNob3dFcnJvcihg6K+36YCJ5oupJHt0aGlzLmRhdGEudGFnX3NlbGVjdGlvbn1gKVxuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWZvcm1EYXRhLnByaWNlKSB7XG4gICAgICB0aGlzLnNob3dFcnJvcign6K+36L6T5YWl5Lu35qC8JylcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGxldCBkYXRhID0gZGVlcENsb25lKGZvcm1EYXRhKVxuICAgIGRhdGEucGhvdG8gPSB0aGlzLmRhdGEucGhvdG9cbiAgICBpZiAodGhpcy5kYXRhLnRhZ19zZWxlY3Rpb24gIT09ICdfaW5wdXQnKSB7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBkYXRhLnRhZ19pZCA9IHRoaXMuZGF0YS50YWdzLmZpbmQoKGU6IGFueSkgPT4gZS5uYW1lID09PSB0aGlzLmRhdGEudGFnX3NlbGVjdGlvbikuaWRcbiAgICAgIGRhdGEubmFtZSA9IHRoaXMuZGF0YS50YWdcbiAgICB9XG4gICAgaWYgKHRoaXMuZGF0YS5wYXJlbnQpIHtcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIGRhdGEucGFyZW50X2lkID0gdGhpcy5kYXRhLnBhcmVudC5pZFxuICAgIH1cblxuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfmj5DkuqTkuK0nIH0pXG4gICAgbGV0IHByb21pc2VcbiAgICBpZiAodGhpcy5kYXRhLmNhdGVnb3J5KSB7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBwcm9taXNlID0gcGF0Y2goYC9jYXJnb19jYXRlZ29yaWVzLyR7dGhpcy5kYXRhLmNhdGVnb3J5LmlkfWAsIGRhdGEpXG4gICAgfSBlbHNlIHtcbiAgICAgIHByb21pc2UgPSBwb3N0KGAvY2FyZ29fY2F0ZWdvcmllcz9jYXJnb19pZD0ke3RoaXMuZGF0YS5jYXJnb0lkfWAsIGRhdGEpXG4gICAgfVxuICAgIHByb21pc2UudGhlbigoKSA9PiB7XG4gICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICB3eC5uYXZpZ2F0ZUJhY2soKVxuICAgIH0pLmNhdGNoKCgpID0+IHtcbiAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgIHRpdGxlOiAn6K+35rGC5aSx6LSl77yM6K+36YeN5paw5bCd6K+VJyxcbiAgICAgICAgaWNvbjogJ25vbmUnXG4gICAgICB9KVxuICAgIH0pXG4gIH1cbn0pXG4iXX0=