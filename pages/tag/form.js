"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var index_1 = require("../../request/index");
var deepClone_1 = require("../../utils/deepClone");
Page({
    data: {
        ready: false,
        tagType: '',
        tag: null,
        formData: {
            name: '',
        },
        tagValues: [{ id: 0, value: '' }],
    },
    onLoad: function (options) {
        var _this = this;
        if (options.id) {
            wx.showLoading({ title: '加载中' });
            index_1.get("/tags/" + options.id).then(function (res) {
                wx.hideLoading();
                var tagValues = JSON.parse(res.data.value).map(function (e, i) { return { id: i, value: e }; });
                var formData = { name: res.data.name };
                _this.setData({ tag: res.data, tagValues: tagValues, formData: formData, ready: true });
            }).catch(function () {
                wx.hideLoading();
            });
        }
        else if (options.tagType === 'bill') {
            wx.showLoading({ title: '加载中' });
            index_1.get("/tags?tag_type=" + options.tagType).then(function (res) {
                wx.hideLoading();
                var tag, tagValues;
                if (res.data.length > 0) {
                    tag = res.data[0];
                    tagValues = JSON.parse(tag.value).map(function (e, i) { return { id: i, value: e }; });
                }
                else {
                    tagValues = _this.data.tagValues;
                }
                _this.setData({ tag: tag, tagValues: tagValues, tagType: options.tagType, ready: true });
            }).catch(function () {
                wx.hideLoading();
            });
        }
        else {
            this.setData({ ready: true });
        }
    },
    addTagValue: function () {
        var tagValues = this.data.tagValues;
        tagValues.push({ id: tagValues.length, value: '' });
        this.setData({ tagValues: tagValues });
    },
    deleteTagValue: function (e) {
        var _this = this;
        var id = e.currentTarget.dataset.id;
        var tagValues = this.data.tagValues;
        if (tagValues[id].value) {
            wx.showModal({
                content: '是否确认删除该标签?',
                success: function (res) {
                    if (res.confirm) {
                        tagValues.splice(id, 1);
                        _this.setData({ tagValues: tagValues });
                    }
                }
            });
        }
        else {
            tagValues.splice(id, 1);
            this.setData({ tagValues: tagValues });
        }
    },
    onTagValueChange: function (e) {
        var id = e.currentTarget.dataset.id;
        var tagValues = this.data.tagValues;
        tagValues[id].value = e.detail.value;
        this.setData({ tagValues: tagValues });
    },
    formInputChange: function (e) {
        var _a;
        var field = e.currentTarget.dataset.field;
        this.setData((_a = {},
            _a["formData." + field] = e.detail.value,
            _a));
    },
    showError: function (error) {
        this.setData({
            error: error
        });
    },
    submit: function () {
        var formData = this.data.formData;
        if (this.data.tagType !== 'bill' && !formData.name) {
            this.showError('请输入标签名称');
            return;
        }
        var tagValues = this.data.tagValues;
        if (tagValues.length === 0) {
            this.showError('至少需要设置一个标签值');
            return;
        }
        for (var _i = 0, tagValues_1 = tagValues; _i < tagValues_1.length; _i++) {
            var v = tagValues_1[_i];
            if (!v.value) {
                this.showError('请输入标签值');
                return;
            }
        }
        var data = deepClone_1.default(formData);
        data.tag_type = this.data.tagType || 'cargo_category';
        data.value = JSON.stringify(tagValues.map(function (e) { return e.value; }));
        wx.showLoading({ title: '提交中' });
        var promise;
        if (this.data.tag) {
            promise = index_1.patch("/tags/" + this.data.tag.id, data);
        }
        else {
            promise = index_1.post('/tags', data);
        }
        promise.then(function () {
            wx.hideLoading();
            wx.navigateBack();
        }).catch(function () {
            wx.hideLoading();
            wx.showToast({
                title: '请求失败，请重新尝试',
                icon: 'none'
            });
        });
    },
    deleteTag: function () {
        var _this = this;
        wx.showModal({
            content: '是否确认删除该标签?',
            success: function (res) {
                if (res.confirm) {
                    wx.showLoading({ title: '删除中' });
                    index_1.del("/tags/" + _this.data.tag.id).then(function () {
                        wx.hideLoading();
                        wx.navigateBack();
                    }).catch(function () {
                        wx.hideLoading();
                        wx.showToast({
                            title: '请求失败，请重新尝试',
                            icon: 'none'
                        });
                    });
                }
            }
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImZvcm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBMkQ7QUFDM0QsbURBQTZDO0FBRTdDLElBQUksQ0FBQztJQUNILElBQUksRUFBRTtRQUNKLEtBQUssRUFBRSxLQUFLO1FBQ1osT0FBTyxFQUFFLEVBQUU7UUFDWCxHQUFHLEVBQUUsSUFBSTtRQUNULFFBQVEsRUFBRTtZQUNSLElBQUksRUFBRSxFQUFFO1NBQ1Q7UUFDRCxTQUFTLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDO0tBQ2xDO0lBRUQsTUFBTSxFQUFOLFVBQU8sT0FBTztRQUFkLGlCQTZCQztRQTVCQyxJQUFJLE9BQU8sQ0FBQyxFQUFFLEVBQUU7WUFDZCxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUE7WUFDaEMsV0FBRyxDQUFDLFdBQVMsT0FBTyxDQUFDLEVBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLEdBQUc7Z0JBQ2pDLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQTtnQkFDaEIsSUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFDLENBQU0sRUFBRSxDQUFNLElBQU8sT0FBTyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxDQUFBLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQ3BHLElBQU0sUUFBUSxHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUE7Z0JBQ3hDLEtBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxTQUFTLFdBQUEsRUFBRSxRQUFRLFVBQUEsRUFB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SixDQUFDO0lBRUQsU0FBUztRQUFULGlCQW9CQztRQW5CQyxFQUFFLENBQUMsU0FBUyxDQUFDO1lBQ1gsT0FBTyxFQUFFLFlBQVk7WUFDckIsT0FBTyxFQUFFLFVBQUEsR0FBRztnQkFDVixJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUU7b0JBQ2YsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFBO29CQUVoQyxXQUFHLENBQUMsV0FBUyxLQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFJLENBQUMsQ0FBQyxJQUFJLENBQUM7d0JBQ3BDLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQTt3QkFDaEIsRUFBRSxDQUFDLFlBQVksRUFBRSxDQUFBO29CQUNuQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7d0JBQ1AsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFBO3dCQUNoQixFQUFFLENBQUMsU0FBUyxDQUFDOzRCQUNYLEtBQUssRUFBRSxZQUFZOzRCQUNuQixJQUFJLEVBQUUsTUFBTTt5QkFDYixDQUFDLENBQUE7b0JBQ0osQ0FBQyxDQUFDLENBQUE7aUJBQ0g7WUFDSCxDQUFDO1NBQ0YsQ0FBQyxDQUFBO0lBQ0osQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldCwgcG9zdCwgcGF0Y2gsIGRlbCB9IGZyb20gJy4uLy4uL3JlcXVlc3QvaW5kZXgnXG5pbXBvcnQgZGVlcENsb25lIGZyb20gJy4uLy4uL3V0aWxzL2RlZXBDbG9uZSdcblxuUGFnZSh7XG4gIGRhdGE6IHtcbiAgICByZWFkeTogZmFsc2UsXG4gICAgdGFnVHlwZTogJycsXG4gICAgdGFnOiBudWxsLFxuICAgIGZvcm1EYXRhOiB7XG4gICAgICBuYW1lOiAnJyxcbiAgICB9LFxuICAgIHRhZ1ZhbHVlczogW3sgaWQ6IDAsIHZhbHVlOiAnJyB9XSxcbiAgfSxcblxuICBvbkxvYWQob3B0aW9ucykge1xuICAgIGlmIChvcHRpb25zLmlkKSB7XG4gICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn5Yqg6L295LitJyB9KVxuICAgICAgZ2V0KGAvdGFncy8ke29wdGlvbnMuaWR9YCkudGhlbihyZXMgPT4ge1xuICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgIGNvbnN0IHRhZ1ZhbHVlcyA9IEpTT04ucGFyc2UocmVzLmRhdGEudmFsdWUpLm1hcCgoZTogYW55LCBpOiBhbnkpID0+IHsgcmV0dXJuIHsgaWQ6IGksIHZhbHVlOiBlIH0gfSlcbiAgICAgICAgY29uc3QgZm9ybURhdGEgPSB7IG5hbWU6IHJlcy5kYXRhLm5hbWUgfVxuICAgICAgICB0aGlzLnNldERhdGEoeyB0YWc6IHJlcy5kYXRhLCB0YWdWYWx1ZXMsIGZvcm1EYXRhLCByZWFkeTogdHJ1ZSB9KVxuICAgICAgfSkuY2F0Y2goKCkgPT4ge1xuICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICB9KVxuICAgIH0gZWxzZSBpZiAob3B0aW9ucy50YWdUeXBlID09PSAnYmlsbCcpIHtcbiAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfliqDovb3kuK0nIH0pXG4gICAgICBnZXQoYC90YWdzP3RhZ190eXBlPSR7b3B0aW9ucy50YWdUeXBlfWApLnRoZW4ocmVzID0+IHtcbiAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgICBsZXQgdGFnLCB0YWdWYWx1ZXNcbiAgICAgICAgaWYgKHJlcy5kYXRhLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICB0YWcgPSByZXMuZGF0YVswXVxuICAgICAgICAgIHRhZ1ZhbHVlcyA9IEpTT04ucGFyc2UodGFnLnZhbHVlKS5tYXAoKGU6IGFueSwgaTogYW55KSA9PiB7IHJldHVybiB7IGlkOiBpLCB2YWx1ZTogZSB9IH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGFnVmFsdWVzID0gdGhpcy5kYXRhLnRhZ1ZhbHVlc1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7IHRhZywgdGFnVmFsdWVzLCB0YWdUeXBlOiBvcHRpb25zLnRhZ1R5cGUsIHJlYWR5OiB0cnVlIH0pXG4gICAgICB9KS5jYXRjaCgoKSA9PiB7XG4gICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2V0RGF0YSh7IHJlYWR5OiB0cnVlIH0pXG4gICAgfVxuICB9LFxuXG4gIGFkZFRhZ1ZhbHVlKCkge1xuICAgIGNvbnN0IHRhZ1ZhbHVlcyA9IHRoaXMuZGF0YS50YWdWYWx1ZXNcbiAgICB0YWdWYWx1ZXMucHVzaCh7IGlkOiB0YWdWYWx1ZXMubGVuZ3RoLCB2YWx1ZTogJycgfSlcbiAgICB0aGlzLnNldERhdGEoeyB0YWdWYWx1ZXMgfSlcbiAgfSxcblxuICBkZWxldGVUYWdWYWx1ZShlOiBhbnkpIHtcbiAgICBjb25zdCB7IGlkIH0gPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldFxuICAgIGNvbnN0IHRhZ1ZhbHVlcyA9IHRoaXMuZGF0YS50YWdWYWx1ZXNcblxuICAgIGlmICh0YWdWYWx1ZXNbaWRdLnZhbHVlKSB7XG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICBjb250ZW50OiAn5piv5ZCm56Gu6K6k5Yig6Zmk6K+l5qCH562+PycsXG4gICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgaWYgKHJlcy5jb25maXJtKSB7XG4gICAgICAgICAgICB0YWdWYWx1ZXMuc3BsaWNlKGlkLCAxKVxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHsgdGFnVmFsdWVzIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICB0YWdWYWx1ZXMuc3BsaWNlKGlkLCAxKVxuICAgICAgdGhpcy5zZXREYXRhKHsgdGFnVmFsdWVzIH0pXG4gICAgfVxuICB9LFxuXG4gIG9uVGFnVmFsdWVDaGFuZ2UoZTogYW55KSB7XG4gICAgY29uc3QgeyBpZCB9ID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXRcbiAgICBjb25zdCB0YWdWYWx1ZXMgPSB0aGlzLmRhdGEudGFnVmFsdWVzXG4gICAgdGFnVmFsdWVzW2lkXS52YWx1ZSA9IGUuZGV0YWlsLnZhbHVlXG4gICAgdGhpcy5zZXREYXRhKHsgdGFnVmFsdWVzIH0pO1xuICB9LFxuXG4gIGZvcm1JbnB1dENoYW5nZShlOiBhbnkpIHtcbiAgICBjb25zdCB7IGZpZWxkIH0gPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldFxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBbYGZvcm1EYXRhLiR7ZmllbGR9YF06IGUuZGV0YWlsLnZhbHVlXG4gICAgfSlcbiAgfSxcblxuICBzaG93RXJyb3IoZXJyb3I6IHN0cmluZykge1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBlcnJvclxuICAgIH0pXG4gIH0sXG5cbiAgc3VibWl0KCkge1xuICAgIGNvbnN0IGZvcm1EYXRhID0gdGhpcy5kYXRhLmZvcm1EYXRhXG5cbiAgICBpZiAodGhpcy5kYXRhLnRhZ1R5cGUgIT09ICdiaWxsJyAmJiAhZm9ybURhdGEubmFtZSkge1xuICAgICAgdGhpcy5zaG93RXJyb3IoJ+ivt+i+k+WFpeagh+etvuWQjeensCcpXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBjb25zdCB0YWdWYWx1ZXMgPSB0aGlzLmRhdGEudGFnVmFsdWVzXG4gICAgaWYgKHRhZ1ZhbHVlcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuc2hvd0Vycm9yKCfoh7PlsJHpnIDopoHorr7nva7kuIDkuKrmoIfnrb7lgLwnKVxuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGZvciAoY29uc3QgdiBvZiB0YWdWYWx1ZXMpIHtcbiAgICAgIGlmICghdi52YWx1ZSkge1xuICAgICAgICB0aGlzLnNob3dFcnJvcign6K+36L6T5YWl5qCH562+5YC8JylcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGRhdGEgPSBkZWVwQ2xvbmUoZm9ybURhdGEpXG4gICAgZGF0YS50YWdfdHlwZSA9IHRoaXMuZGF0YS50YWdUeXBlIHx8ICdjYXJnb19jYXRlZ29yeSdcbiAgICBkYXRhLnZhbHVlID0gSlNPTi5zdHJpbmdpZnkodGFnVmFsdWVzLm1hcChlID0+IGUudmFsdWUpKVxuXG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+aPkOS6pOS4rScgfSlcbiAgICBsZXQgcHJvbWlzZVxuICAgIGlmICh0aGlzLmRhdGEudGFnKSB7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBwcm9taXNlID0gcGF0Y2goYC90YWdzLyR7dGhpcy5kYXRhLnRhZy5pZH1gLCBkYXRhKVxuICAgIH0gZWxzZSB7XG4gICAgICBwcm9taXNlID0gcG9zdCgnL3RhZ3MnLCBkYXRhKVxuICAgIH1cbiAgICBwcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgd3gubmF2aWdhdGVCYWNrKClcbiAgICB9KS5jYXRjaCgoKSA9PiB7XG4gICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICB0aXRsZTogJ+ivt+axguWksei0pe+8jOivt+mHjeaWsOWwneivlScsXG4gICAgICAgIGljb246ICdub25lJ1xuICAgICAgfSlcbiAgICB9KVxuICB9LFxuXG4gIGRlbGV0ZVRhZygpIHtcbiAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgY29udGVudDogJ+aYr+WQpuehruiupOWIoOmZpOivpeagh+etvj8nLFxuICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgaWYgKHJlcy5jb25maXJtKSB7XG4gICAgICAgICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+WIoOmZpOS4rScgfSlcbiAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgZGVsKGAvdGFncy8ke3RoaXMuZGF0YS50YWcuaWR9YCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgICAgICB3eC5uYXZpZ2F0ZUJhY2soKVxuICAgICAgICAgIH0pLmNhdGNoKCgpID0+IHtcbiAgICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICAgIHRpdGxlOiAn6K+35rGC5aSx6LSl77yM6K+36YeN5paw5bCd6K+VJyxcbiAgICAgICAgICAgICAgaWNvbjogJ25vbmUnXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG59KVxuIl19